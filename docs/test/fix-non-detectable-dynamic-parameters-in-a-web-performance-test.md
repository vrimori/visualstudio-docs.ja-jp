---
title: Web パフォーマンス テストでの検出できない動的パラメーターの修正
ms.date: 10/19/2016
ms.topic: conceptual
helpviewer_keywords:
- walkthroughs, load tests
- load tests, walkthroughs
- load tests, correlating dynamic parameters
ms.assetid: 92dff25c-36ee-4135-acdd-315c4962fa11
author: gewarren
ms.author: gewarren
manager: douge
ms.prod: visual-studio-dev15
ms.openlocfilehash: 1639128be249c6ca91b611819a8a09394fad499d
ms.sourcegitcommit: 37fb7075b0a65d2add3b137a5230767aa3266c74
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/02/2019
ms.locfileid: "53848481"
---
# <a name="fix-non-detectable-dynamic-parameters-in-a-web-performance-test"></a>Web パフォーマンス テストでの検出できない動的パラメーターの修正

Web サイトによっては、一部の Web 要求の処理に動的パラメーターを使用することがあります。 動的パラメーターとは、ユーザーがアプリケーションを実行するたびに値が再生成されるパラメーターです。 動的パラメーターの例として、セッション ID があります。 通常、この値を使用して 5 ～ 30 分の間隔で変更される値を取得します。 Web パフォーマンス テスト レコーダーと再生エンジンによって、最も一般的な種類の動的パラメーターが自動的に処理されます。

-   クッキー値で設定される動的パラメーターの値。 Web パフォーマンス テスト エンジンによって、再生中にそれらの値が自動的に処理されます。

-   ASP.NET ビュー ステートなど HTML ページ上の隠しフィールドで設定される動的パラメーターの値。 これらの値はレコーダーによって自動的に処理され、隠しフィールドの抽出ルールがテストに追加されます。

-   クエリ文字列またはフォーム ポスト パラメーターとして設定される動的パラメーターの値。 これらの値は、Web パフォーマンス テストの記録後に、動的パラメーターの検出によって処理されます。

一部の種類の動的パラメーターは検出されません。 動的な値はテストが実行されるたびに異なるため、検出されない動的パラメーターがあると、Web パフォーマンス テストが実行に失敗します。 これらのパラメーターを正しく処理するために、Web パフォーマンス テストの動的パラメーターに抽出規則を手動で追加することができます。

[!INCLUDE [web-load-test-deprecated](includes/web-load-test-deprecated.md)]

## <a name="create-and-run-a-web-app-with-dynamic-parameters"></a>動的パラメーターを使用する Web アプリケーションを作成および実行する

検出可能な動的パラメーターと検出不可能な動的パラメーターの両方を示すために、単純な ASP.NET Web アプリケーションを作成します。これには、いくつかのコントロールとカスタム コードを使用する 3 つの Web フォームが含まれています。 また、動的パラメーターを特定する方法と、それらの処理方法も説明します。

1.  **DynamicParameterSample** という名前の新しい ASP.NET プロジェクトを作成します。

     ![空の ASP.NET Web アプリケーション プロジェクトを作成する](../test/media/web_test_dynamicparameter_aspproject.png)

2.  *Querystring.aspx* という名前の Web フォームを追加します。

3.  デザイン ビューで、HiddenField をページにドラッグし、(ID) プロパティの値を HiddenFieldSessionID に変更します。

     ![HiddenField を追加する](../test/media/web_test_dynamicparameter_hiddenfield.png)

4.  Querystring ページのソース ビューに変更し、次に示す ASP.NET および JavaScript の強調表示されたコードを追加します。このコードは、模擬的なセッション ID 動的パラメーターの生成に使用されます。

    ```html
    <head runat="server">
    <title>JavaScript dynamic property correlation sample</title><script type="text/javascript" language="javascript">    <!--        function jScriptQueryString()         {            var Hidden = document.getElementById("HiddenFieldSessionID");            var sessionId = Hidden.value;            window.location = 'JScriptQuery.aspx?CustomQueryString=jScriptQueryString___' + sessionId;         }    //--></script>
    </head>
    <body>
        <form id="form1" runat="server">
        <div>
             <a name="QuerystringHyperlink" href="ASPQuery.aspx?CustomQueryString=ASPQueryString___<%= Session.SessionID %>">Dynamic querystring generated by ASP.net</a>         <br/>         <br/>         <a href="javascript:jScriptQueryString()">Dynamic querystring generated by javascript </a>
        </div>
        <asp:HiddenField ID="HiddenFieldSessionID" runat="server" />
        </form>
    </body>
    </html>
    ```

5.  *Querystring.aspx.cs* ファイルを開き、次の強調表示されたコードを Page_Load メソッドに追加します。

    ```csharp
    public partial class Querystring : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            Session.Add("Key", "Value");HiddenFieldSessionID.Value = Session.SessionID;
        }
    }
    ```

6.  *ASPQuery.aspx* という名前で 2 つ目の Web フォームを追加します。

7.  デザイン ビューで、**Label** をページにドラッグし、**(ID)** プロパティの値を **IndexLabel** に変更します。

     ![ラベルを Web フォームに追加する](../test/media/web_test_dynamicparameter_label.png)

8.  **HyperLink** をページにドラッグし、**Text** プロパティを **Back** に変更します。

     ![ハイパーリンクを Web フォームに追加する](../test/media/web_test_dynamicparameter_hyperlink.png)

9. **NavigationURL** プロパティの **(...)** をクリックします。

     ![NavigateURL プロパティを編集する](../test/media/web_test_dynamicparameter_hyperlink_navurl.png)

     *Querystring.aspx* をクリックします。

     ![URL として Querystring.aspx を選択する](../test/media/web_test_dynamicparameter_hyperlink_navurl2.png)

10. *ASPQuery.aspx.cs* ファイルを開き、次の強調表示されたコードを Page_Load メソッドに追加します。

    ```csharp
    protected void Page_Load(object sender, EventArgs e)
            {
                int index;            string qstring;            string dateportion;            string sessionidportion;            qstring = Request.QueryString["CustomQueryString"];            index = qstring.IndexOf("___");            dateportion = qstring.Substring(0, index);            index += 3;            sessionidportion = qstring.Substring(index, qstring.Length - index);            if (sessionidportion != Session.SessionID)            {                Response.StatusCode = 401;                IndexLabel.Text = "Failure!  Invalid querystring parameter found.";            }            else            {                IndexLabel.Text = "Success.  Dynamic querystring parameter was found.";            }            IndexLabel.Text += "<br>\r\n";
            }
    ```

11. *JScriptQuery.aspx* という名前で 3 つ目の Web フォームを追加します。

     2 番目のページの場合と同様に、**Label** をフォームにドラッグし、**(ID)** プロパティを **IndexLabel** に設定します。**Hyperlink** をフォームにドラッグし、**Text** プロパティを **Back** に設定して、**NavigationURL** プロパティを **Querystring.aspx** に設定します。

     ![3 つ目の Web フォームを追加および構成する](../test/media/web_test_dynamicparameter_addwebform3.png)

12. *JScriptQuery.aspx.cs* ファイルを開き、次の強調表示されたコードを Page_Load メソッドに追加します。

    ```csharp
    protected void Page_Load(object sender, EventArgs e)
            {
                int index;            string qstring;            string dateportion;            string sessionidportion;            qstring = Request.QueryString["CustomQueryString"];            index = qstring.IndexOf("___");            dateportion = qstring.Substring(0, index);            index += 3;            sessionidportion = qstring.Substring(index, qstring.Length - index);            if (sessionidportion != Session.SessionID)            {                Response.StatusCode = 401;                IndexLabel.Text = "Failure!  Invalid querystring parameter found.";            }            else            {                IndexLabel.Text = "Success.  Dynamic querystring parameter was found.";            }            IndexLabel.Text += "<br>\r\n";
            }
    ```

13. プロジェクトを保存します。

14. **ソリューション エクスプローラー**で、*Querystring.aspx* をスタート ページとして設定します。

     ![Querystring.aspx をスタート ページとして設定する](../test/media/web_test_dynamicparameter_setstartpage.png)

15. **Ctrl** キーを押しながら **F5** キーを押して、ブラウザーで Web アプリケーションを実行します。 URL をコピーします。 この URL は、テストを記録するときに必要になります。

16. 両方のリンクを試します。 どちらについても、"Success.  Dynamic querystring parameter found." というメッセージが示されます。

     ![Web アプリを実行する](../test/media/web_test_dynamicparameter_runapp.png)

     ![成功&#33;](../test/media/web_test_dynamicparameter_runapp2.png)

## <a name="create-a-web-performance-test"></a>Web パフォーマンス テストを作成する

1.  ソリューションに Web パフォーマンス テストとロード テストのプロジェクトを追加します。

     ![Web パフォーマンスとロード テストのプロジェクトを追加する](../test/media/web_test_dynamicparameter_addtestproject.png)

2.  WebTest1.webtest という名前を DynamicParameterSampleApp.webtest に変更します。

     ![Web パフォーマンス テストの名前を変更する](../test/media/web_test_dynamicparameter_renametest.png)

3.  テストを記録します。

     ![Web パフォーマンス テストを記録する](../test/media/web_test_dynamicparameter_recordtest.png)

4.  テストする Web サイトの URL をコピーしてブラウザーに貼り付けます。

     ![テストする Web サイトの URL を貼り付ける](../test/media/web_test_dynamicparameter_recordtest2.png)

5.  Web アプリケーションを参照します。 ASP.NET リンク、Back リンク、および javascript リンクを選択し、再度 Back リンクを選択します。

     Web アプリ内を移動するとき、Web テスト レコーダーに HTTP 要求と応答 URL が表示されます。

6.  テスト レコーダーの **[停止]** ボタンをクリックします。

     動的パラメーターを検出するためのダイアログ ボックスには、受信した HTTP 応答でのパラメーターの検出状況を示す進行状況バーも表示されます。

7.  ASPQuery ページの CustomQueryString の動的パラメーターは自動的に検出されています。 ただし、JScriptQuery ページの CustomQueryString の動的パラメーターは検出されていません。

     *Querystring.aspx* に抽出規則を追加し、ASPQuery ページにバインドするには、**[OK]** をクリックします。

     ![検出された動的パラメーターを昇格させる](../test/media/web_test_dynamicparameter_promotedialog.png)

     抽出規則は、*Querystring.aspx* への 1 つ目の要求に追加されます。

     ![要求に追加された抽出規則](../test/media/web_test_dynamicparameter_autoextractionrule.png)

     *ASPQuery.aspx* の要求ツリーで 2 番目の要求を展開し、CustomQueryString の値が抽出規則にバインドされていることを確認します。

     ![抽出規則にバインドされた CustomQueryString](../test/media/web_test_dynamicparameter_autoextractionrule2.png)

8.  テストを保存します。

## <a name="run-the-test-to-isolate-the-non-detected-dynamic-parameter"></a>検出されない動的パラメーターを特定するテストを実行する

1.  テストを実行します。

     ![Web パフォーマンス テストを実行する](../test/media/web_test_dynamicparameter_runtest.png)

2.  *JScriptQuery.aspx* ページに対する 4 番目の要求は失敗します。 Web テストに移動します。

     ![テスト結果に示された動的パラメーター エラー](../test/media/web_test_dynamicparameter_runresults.png)

     エディターで、*JScriptQuery.aspx* 要求ノードが強調表示されます。 このノードを展開します。CustomQueryString の "1v0yhyiyr0raa2w4j4pwf5zl" が動的な部分と思われます。

     ![CustomQueryString で動的パラメーターと思われる部分](../test/media/web_test_dynamicparameter_runresults2.png)

3.  Web パフォーマンス テスト結果ビューアーに戻って、失敗した *JScriptQuery.aspx* ページを選択します。 次に、[要求] タブをクリックし、[生データの表示] チェック ボックスがオフになっていることを確認します。スクロール ダウンし、CustomQueryString の [クイック検索] をクリックします。

     ![クイック検索を使用して動的パラメーターを特定する](../test/media/web_test_dynamicparameter_runresultsquckfind.png)

4.  テスト エディターに表示された内容から、*JScriptQuery.aspx* 要求の CustomQueryString には `jScriptQueryString___1v0yhyiyr0raa2w4j4pwf5zl` という値が割り当てられており、動的と思われる部分は "1v0yhyiyr0raa2w4j4pwf5zl" だということがわかっています。 [検索する文字列] ドロップダウン リストで、動的と思われる部分を検索文字列から削除します。 文字列は、"CustomQueryString=jScriptQueryString___" のようになります。

     動的パラメーターには、エラーが存在する要求より前の要求で値が割り当てられます。 このため、[上へ検索] チェック ボックスをオンにして、[次を検索] をクリックし、[要求] パネルで先行する *Querystring.aspx* の要求が強調表示されるまで検索を続けます。 [次を検索] を 3 回クリックすると、その状態になります。

     ![クイック検索を使用して動的パラメーターを特定する](../test/media/web_test_dynamicparameter_runresultsquckfind4.png)

     [応答] タブや、前に実装した JavaScript (次に示すコード) からわかるように、クエリ文字列パラメーター CustomQueryString には "jScriptQueryString___" という値が割り当てられており、その後に var sessionId からの戻り値が連結されています。

    ```javascript
    function jScriptQueryString()          {             var Hidden = document.getElementById("HiddenFieldSessionID");             var sessionId = Hidden.value;             window.location = 'JScriptQuery.aspx?CustomQueryString=jScriptQueryString___' + sessionId;          }

    ```

     これで、エラーが発生する場所がわかり、sessionId の値を抽出する必要があることもわかりました。 ただし、抽出される値は単なるテキストであるため、sessionId の実際の値が表示される文字列を探して、さらにエラーを特定する必要があります。 コードを調べると、var sessionId は、HiddenFieldSessionID によって返される値と等しいことがわかります。

5.  HiddenFieldSessionID のクイック検索を使用します。このとき、[上へ検索] チェック ボックスをオフにし、[現在の要求] チェック ボックスをオンにします。

     ![HiddenFieldSession でクイック検索を使用する](../test/media/web_test_dynamicparameter_runresultsquckfindhiddensession.png)

     返された値が元の Web パフォーマンス テスト記録と同じ文字列ではないことに注意してください。 このテスト実行で返された値は "5w4v3yrse4wa4axrafykqksq"、元の記録で返された値は "1v0yhyiyr0raa2w4j4pwf5zl" です。 値が元の記録の値と一致しないので、エラーが生成されます。

6.  元の記録の動的パラメーターを修正する必要があるため、ツール バーの [記録された結果] をクリックします。

     ![[記録された結果] を選択する](../test/media/web_test_dynamicparameter_recordedresult.png)

7.  記録された結果で、3 番目の要求を選択します。これは、テスト実行の結果で特定した *Querystringrequest.aspx* 要求と同じです。

     ![記録された結果で同じ要求を選択する](../test/media/web_test_dynamicparameter_recordedresultsselectnode.png)

     [応答] タブをクリックしてスクロール ダウンし、前に特定した、元の動的パラメーター値 "1v0yhyiyr0raa2w4j4pwf5zl" を選択して、抽出規則を追加します。

     ![動的パラメーターに抽出規則を追加する](../test/media/web_test_dynamicparameter_recordedresultaddextractionrule.png)

     新しい抽出規則が *Querystring.aspx* 要求に追加され、"Param0" という値が割り当てられます。

     パラメーターをバインドするための、抽出されたテキストに対する一致が見つかったことを示すメッセージがダイアログ ボックスに表示された場合は、**[はい]** をクリックします。

     ![作成された抽出規則](../test/media/web_test_dynamicparameter_addextractiondialog.png)

8.  **[次を検索]** をクリックします。 最初の一致は、JScriptQuery ページの CustomQueryString のパラメーターであり、変更が必要です。

     ![パラメーターのテキストを検索/置換する](../test/media/web_test_dynamicparameter_addextractionfindreplace.png)

9. **[置換]** をクリックします。

     ![テキストをパラメーターで置き換える](../test/media/web_test_dynamicparameter_addextractionfindreplace2.png)

     *JScriptQuery.aspx* 要求の下の QueryString パラメーターが、新しいコンテキスト パラメーターの "CustomQueryString=jScriptQueryString___{{Param0}}" を使って更新されます。

     ![QueryString に適用されたパラメーター](../test/media/web_test_dynamicparameter_addextractionfindreplace3.png)

10. **検索と置換**のダイアログ ボックスを閉じます。 要求ツリーで、検出された動的パラメーターと、関連付けた検出されない動的パラメーターとの間に同様の構造があることを確認します。

     ![検出され関連付けられた動的パラメーター](../test/media/web_test_dynamicparameter_conclusion.png)

11. テストを実行します。 今回は失敗せずに実行されます。

## <a name="qa"></a>Q&A

### <a name="q-can-i-re-run-dynamic-parameter-detection-if-my-web-app-gets-modified"></a>Q:Web アプリケーションが変更された場合は、動的パラメーターの検出を再実行できますか。

 **A:** はい。次の手順を使用してください。

1.  ツール バーの **[動的パラメーターを Web テスト パラメーターに昇格]** をクリックします。

     検出プロセスの完了後、動的パラメーターが検出された場合、**[動的パラメーターを Web テスト パラメーターに昇格]** ダイアログ ボックスが表示されます。

     動的パラメーターは、[動的パラメーター] 列に表示されます。 動的パラメーターの抽出元およびバインド先の要求が、[応答からパラメーターを抽出] 列と [要求にバインド] 列の下に表示されます。

     **[動的パラメーターを Web テスト パラメーターに昇格]** ダイアログ ボックスで動的パラメーターを選択すると、Web パフォーマンス テスト エディターの要求ツリーで 2 つの要求が強調表示されます。 最初の要求は、抽出規則が追加される要求です。 2 番目の要求では、抽出された値がバインドされます。

2.  自動的に関連付ける動的パラメーターの横にあるチェック ボックスをオンまたはオフにします。 既定では、すべての動的パラメーターがオンになっています。

### <a name="q-do-i-need-to-configure-visual-studio-to-detect-dynamic-parameters"></a>Q:動的パラメーターが検出されるように Visual Studio を構成する必要はありますか。

 **A:** Visual Studio の既定の構成では、Web パフォーマンス テストの記録時に動的パラメーターが検出されます。 ただし、動的パラメーターを検出しないように Visual Studio のオプションが構成されている場合や、テストする Web アプリケーションが追加の動的パラメーターで変更される場合は、Web パフォーマンス テスト エディターで動的パラメーターの検出を実行できます。