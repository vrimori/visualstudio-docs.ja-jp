---
title: 依存関係図を使用したコードの検証
ms.date: 09/28/2018
ms.topic: conceptual
helpviewer_keywords:
- dependency diagrams, validating
- validation, dependency diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, dependency diagrams
- MSBuild, validating code
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- multiple
ms.prod: visual-studio-dev15
ms.openlocfilehash: fd4e3681ad30dc54d9240fff94e1bf60bf5e88cf
ms.sourcegitcommit: 2193323efc608118e0ce6f6b2ff532f158245d56
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/25/2019
ms.locfileid: "55033948"
---
# <a name="validate-code-with-dependency-diagrams"></a>依存関係図を使用したコードの検証

## <a name="why-use-dependency-diagrams"></a>依存関係図を使用する理由

コードが設計と競合しないことを確認するには、Visual Studio での依存関係図を使用してコードを検証します。 これが次の点で役立つ場合があります。

- 依存関係図に、コード内の依存関係と依存関係の競合を検索します。

- 提案された変更によって影響を受ける可能性がある依存関係を見つける。

   たとえば、潜在的なアーキテクチャの変更内容を表示し、影響を受ける依存関係を表示するコードを検証するには、依存関係図を編集できます。

- コードを別の設計にリファクターまたは移行する。

   コードを別のアーキテクチャに移動したときに作業が必要なコード、または依存関係を見つけます。

**必要条件**

- Visual Studio

- 依存関係図をモデリング プロジェクトを含むソリューションです。 この依存関係図を検証する c# または Visual Basic のプロジェクトの成果物にリンクする必要があります。 参照してください[コードから依存関係図を作成する](../modeling/create-layer-diagrams-from-your-code.md)します。

> [!NOTE]
> Visual Studio 2017 で .NET Core プロジェクトでは、依存関係図はサポートされていません。

この機能をサポートする Visual Studio のエディションを確認するを参照してください。 [Edition のサポート アーキテクチャとモデリング ツール](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport)します。

Visual Studio で開いている依存関係図から手動でまたはコマンド プロンプトからコードを検証できます。 ビルド ローカル ビルドまたは Azure のパイプラインを実行しているときにコードを自動的に検証することもできます。 参照してください[Channel 9 ビデオ。設計し、依存関係図の使用によるアーキテクチャの検証](http://go.microsoft.com/fwlink/?LinkID=252073)です。

> [!IMPORTANT]
> Team Foundation Server (TFS) を使用してレイヤー検証を実行する場合は、ビルド サーバーで同じバージョンの Visual Studio をインストールすることも必要があります。

## <a name="live-dependency-validation"></a>ライブ依存関係の検証

依存関係の検証が、リアルタイムで行われ、エラーにすぐに表示されます、**エラー一覧**します。

* ライブの検証については、c# および Visual Basic のサポートします。

* ライブ依存関係の検証を使用する場合は、完全ソリューション解析を有効にするに内にある金色のバーからオプションの設定を開き、**エラー一覧**します。

   - ソリューション内のアーキテクチャ上のすべての問題の確認が必要ない場合は、完全に無視金色のバーしてかまいません。
   - 完全ソリューション解析を有効にしない場合は、編集中のファイルだけに対して、分析が行われます。

* ライブの検証を有効にするプロジェクトをアップグレードするときに、ダイアログには、変換の進行状況が表示されます。

* ライブ依存関係検証するためのプロジェクトを更新する場合、NuGet パッケージのバージョンは、すべてのプロジェクトと同じにするはアップグレードされ、使用中の最上位のバージョンは。

* 新しい依存関係検証プロジェクト トリガー プロジェクトの更新を追加します。

## <a name="see-if-an-item-supports-validation"></a>項目で検証がサポートされているかどうかを確認する

Web サイト、Office ドキュメント、プレーン テキスト ファイル、および複数のアプリ間で共有されるプロジェクトのファイルにレイヤーをリンクすることができますが、検証プロセスには含まれません。 個々のレイヤー間に依存関係が表示されない場合、これらのレイヤーにリンクされているプロジェクトやアセンブリへの参照については、検証エラーは表示されません。 このような参照は、コードがこれらの参照を使用している場合を除き、依存関係と見なされません。

1.  依存関係図では、1 つまたは複数のレイヤーを選択します。 で選択内容を右クリックし、クリック**ビュー リンク**します。

2.  **レイヤー エクスプ ローラー**を見て、**検証をサポート**列。 値が false の場合、この項目では検証がサポートされません。

## <a name="include-other-net-assemblies-and-projects-for-validation"></a>検証用に他の .NET アセンブリおよびプロジェクトを含める

対応する .NET アセンブリまたはプロジェクトへの参照に自動的に追加の依存関係図に項目をドラッグすると、**レイヤー参照**モデリング プロジェクト内のフォルダー。 このフォルダーには、検証時に分析されたアセンブリおよびプロジェクトへの参照が格納されます。 手動で依存関係図にドラッグすることがなく、他の .NET アセンブリおよび検証のためのプロジェクトを含めることができます。

1.  **ソリューション エクスプ ローラー**、モデリング プロジェクトを右クリックして、または**レイヤー参照**フォルダー、およびクリック**参照の追加**します。

2.  **参照の追加** ダイアログ ボックスでは、アセンブリまたはプロジェクトを選択しをクリックして**OK**します。

## <a name="validate-code-manually"></a>コードを手動で検証する

ソリューション項目にリンクされている、開いている依存関係図がある場合、は、実行、**検証**ダイアグラムからのショートカット コマンド。 実行するコマンド プロンプトを使用することもできます、 **msbuild**コマンドと、 **/p:ValidateArchitecture**カスタム プロパティを設定**True**します。 たとえば、コードの変更を行う場合、依存関係の競合を早期にキャッチできるようにレイヤー検証を定期的に実行します。

### <a name="validate-code-from-an-open-dependency-diagram"></a>開いている依存関係図からコードを検証します。

1.  ダイアグラム サーフェイスを右クリックし、**アーキテクチャの検証**です。

    > [!NOTE]
    > 既定で、**ビルド アクション**依存関係図 (.layerdiagram) ファイルのプロパティに設定されて**検証**検証プロセスで、ダイアグラムが含まれるようにします。

     **エラー一覧**ウィンドウが発生したエラーを報告します。 検証エラーに関する詳細については、次を参照してください。[を把握して解決のレイヤー検証エラー](#UnderstandingValidationErrors)します。

2.  各エラーのソースを表示するでエラーをダブルクリックして、**エラー一覧**ウィンドウ。

    > [!NOTE]
    > Visual Studio は、エラーのソースではなく、コード マップを表示する可能性があります。 これには、コードの依存関係の図に指定されていないアセンブリに依存しているか、コードの依存関係図で指定されている依存関係がないときに発生します。 コード マップまたはコードをレビューし、依存関係が必要であるかどうかを検証してください。 コード マップの詳細については、次を参照してください。[ソリューション間の依存関係をマップする](../modeling/map-dependencies-across-your-solutions.md)します。

3.  エラーを管理するには、次を参照してください。[検証エラーを管理](#ManageErrors)します。

### <a name="validate-code-at-the-command-prompt"></a>コマンド プロンプトでコードを検証します。

1. Visual Studio コマンド プロンプトを開きます。

2. 次のいずれかを選択します。

   - ソリューションで特定のモデリング プロジェクトに対してコードを検証するには、次のカスタム プロパティを使用して MSBuild を実行します。

       ```
       msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
       ```

     - または

       [参照] をモデリング プロジェクト (.modelproj) を含むフォルダーにファイル サービスおよび依存関係を図し、次のカスタム プロパティを使用して MSBuild を実行します。

       ```
       msbuild /p:ValidateArchitecture=true
       ```

   - ソリューション内のすべてのモデリング プロジェクトに対してコードを検証するには、次のカスタム プロパティを使用して MSBuild を実行します。

       ```
       msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
       ```

     - または

       依存関係図を含むモデリング プロジェクトを含めることが、次のカスタム プロパティを使用して MSBuild を実行する必要がありますしているソリューション フォルダーを参照してください。

       ```
       msbuild /p:ValidateArchitecture=true
       ```

     発生したすべてのエラーが表示されます。 MSBuild の詳細については、次を参照してください。 [MSBuild](../msbuild/msbuild.md)と[MSBuild タスク](../msbuild/msbuild-task.md)します。

   検証エラーに関する詳細については、次を参照してください。[を把握して解決のレイヤー検証エラー](#UnderstandingValidationErrors)します。

### <a name="manage-validation-errors"></a>検証エラーを管理する

開発プロセスの実行中は、検証時に報告される一部の競合を抑制できます。 たとえば、既に解決したエラーや特定のシナリオに関連しないエラーを抑制できます。 エラーを抑制した場合は、Team foundation 作業項目を記録することをお勧めします。

> [!WARNING]
> 作業項目を作成またはそれにリンクするには、既に TFS ソース コード管理 (SCC) に接続されている必要があります。 別の TFS SCC への接続を開こうとすると、Visual Studio が現在のソリューションを自動的に閉じます。 作業項目を作成またはそれにリンクしようとする前に、適切な SCC に接続されていることを確認してください。 Visual Studio の今後のリリースでは、SCC に接続されていないとメニュー コマンドを使用できません。

#### <a name="create-a-work-item-for-a-validation-error"></a>検証エラーの作業項目を作成します。

- **エラー一覧**ウィンドウで、エラーを右クリックし、 をポイント**作業項目の作成**、しを作成する作業項目の種類をクリックします。

これらのタスクを使用して、検証エラーを管理する、**エラー一覧**ウィンドウ。

|**To**|**次の手順します。**|
|-|-|
|検証中に選択したエラーを抑制する|1 つまたは複数選択したエラーを右クリックし、[**検証エラーの管理**、] をクリックし、**エラーの抑制**します。<br /><br /> 抑制されたエラーは、取り消し線付きで表示されます。 次回検証を実行したとき、これらのエラーは表示されません。<br /><br /> 抑制されたエラーは、対応する依存関係図ファイルの .suppressions ファイルで追跡されます。|
|選択したエラーの抑制を停止する|選択した抑制されたエラーまたはエラーを右クリックし、 をポイント**検証エラーの管理**、 をクリックし、**エラーの抑制の停止**。<br /><br /> 次回検証を実行したとき、抑制されたエラーのうち選択したものが表示されます。|
|復元ですべての抑制されたエラー、**エラー一覧**ウィンドウ|任意の場所を右クリックし、**エラー一覧**ウィンドウで、 をポイント**検証エラーの管理**、順にクリックします**抑制されたエラーの表示**します。|
|すべての抑制されたエラーを非表示にする、**エラー一覧**ウィンドウ|任意の場所を右クリックし、**エラー一覧**ウィンドウで、 をポイント**検証エラーの管理**、順にクリックします**抑制されたエラーの非表示にする**します。|

## <a name="validate-code-automatically"></a>コードを自動的に検証する

ローカル ビルドを実行するたびにレイヤー検証を実行できます。 チームは、Azure DevOps を使用している場合は、ゲート チェックイン、これは、カスタム MSBuild タスクと検証エラーを収集するビルド レポートを使用して作成して指定できますでレイヤー検証を実行できます。 ゲート チェックイン ビルドを作成するを参照してください。 [TFVC ゲート チェックイン](/azure/devops/pipelines/build/triggers#gated)します。

### <a name="to-validate-code-automatically-during-a-local-build"></a>ローカル ビルド時にコードを自動的に検証するには

テキスト エディターを使用してモデリング プロジェクト (.modelproj) ファイルを開き、次のプロパティを追加します。

```xml
<ValidateArchitecture>true</ValidateArchitecture>
```

\- または -

1.  **ソリューション エクスプ ローラー**依存関係図または図を含むモデリング プロジェクトを右クリックし、クリックして**プロパティ**します。

2.  **プロパティ**ウィンドウで、設定、モデリング プロジェクトの**アーキテクチャの検証**プロパティを**True**します。

    これには、検証プロセス内のモデリング プロジェクトが含まれます。

3.  **ソリューション エクスプ ローラー**検証に使用する依存関係図 (.layerdiagram) ファイルをクリックします。

4.  **プロパティ**ウィンドウで、ことを確認します、ダイアグラムの**ビルド アクション**プロパティに設定されて**検証**です。

    これには、検証プロセスには依存関係図が含まれます。

エラー一覧 ウィンドウでエラーを管理するには、次を参照してください。[検証エラーの管理](#ManageErrors)します。

## <a name="troubleshoot-layer-validation-issues"></a>レイヤー検証に関する問題のトラブルシューティング

レイヤー検証に関する問題とその解決方法について、次の表で説明します。 これらの問題は、コードと設計の間の競合によって発生するエラーとは異なります。 これらのエラーの詳細については、次を参照してください。[を把握して解決のレイヤー検証エラー](#UnderstandingValidationErrors)します。

|**問題点**|**考えられる原因**|**解決策**|
|-|-|-|
|検証エラーが予期したとおりに発生しない。|検証は、ソリューション エクスプ ローラーでは、その他の依存関係図からコピーされると、同一のモデリング プロジェクト内にある依存関係図では機能しません。 この方法でコピーされる依存関係図には、元の依存関係図と同じ参照が含まれています。|新しい依存関係図をモデリング プロジェクトに追加します。<br /><br /> 元の依存関係図から新しい図に、要素をコピーします。|

## <a name="resolve-layer-validation-errors"></a>レイヤー検証エラーを解決するには

依存関係図と照らし合わせてコードを検証するときに、コードが設計と競合しているときに検証エラーが発生します。 たとえば、次の条件のとき、検証エラーが発生する場合があります。

- 成果物が不適切なレイヤーに割り当てられている。 この場合、成果物を移動します。

- クラスなどの成果物が、アーキテクチャに違反する形で別のクラスを使用している。 この場合、コードをリファクタリングして依存関係を削除します。

これらのエラーを解決するには、コードを更新して、検証時にエラーが表示されなくなるようにします。 この作業は、反復的な方法で実行します。

次のセクションでは、これらのエラーで使用される構文を示し、これらのエラーの意味を説明し、エラーを解決または管理するために実行できることを提示します。

|**構文**|**説明**|
|-|-|
|*ArtifactN*(*ArtifactTypeN*)|*ArtifactN*は依存関係図のレイヤーに関連付けられている成果物。<br /><br /> *ArtifactTypeN*の種類は、 *ArtifactN*などを**クラス**または**メソッド**など。<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*NamespaceNameN*|名前空間の名前。|
|*LayerNameN*|レイヤー図上の依存関係の名前。|
|*DependencyType*|間の依存関係の種類*Artifact1*と*Artifact2*します。 たとえば、 *Artifact1*が、**呼び出し**と関係*Artifact2*します。|

| **エラーの構文** | **エラーの説明** |
|-|-|
| DV0001:**無効な依存関係** | レイヤー参照別のレイヤーにマップされているコード要素にマップされた (名前空間、型、メンバー) は、コード要素が、このレイヤーを含む依存関係検証ダイアグラムでこれらのレイヤー間の依存関係の矢印がない場合は、この問題が報告されます。 これは、依存関係の制約違反です。 |
| DV1001:**無効な名前空間の名前** | この問題は、「Namespace 名を許可する」プロパティには、このコード要素が定義されている名前空間が含まれていないレイヤーに関連付けられているコード要素で報告されます。 これは、名前付けの制約違反です。 定義するコードに関連付けられている要素はレイヤーの名前空間のリストをセミコロンで区分するのには、Namespace 名"許可"の構文が許可されます。 |
| DV1002:**参照できない名前空間への依存関係** | この問題は、レイヤーに関連付けられているし、層の"参照できない Namespace"プロパティで定義されている名前空間で定義されている別のコード要素を参照するコード要素で報告されます。 これは、名前付けの制約違反です。 このレイヤーに関連付けられているコード要素では参照できませんされる名前空間のセミコロンで区切った一覧として「参照できない名前空間」プロパティが定義されていることに注意してください。 |
| DV1003:**許可されていない名前空間の名前** | この問題は、「許可されていない Namespace 名」プロパティには、このコード要素が定義されている名前空間が含まれています。 このレイヤーに関連付けられているコード要素で報告されます。 これは、名前付けの制約違反です。 コードをこのレイヤーに関連付けられている要素は定義できません名前空間のセミコロンで区切った一覧として「名前空間の名前を許可しない」プロパティが定義されていることに注意してください。 |
| DV3001:**不足しているリンク** | レイヤー '*LayerName*'へのリンク'*成果物*' が見つかりません。 アセンブリ参照が存在することを確認してください。 |
| DV9001:**内部エラーが見つかりましたアーキテクチャの分析** | 結果が不完全である可能性があります。 詳細については、ビルド イベント ログの詳細または出力ウィンドウを参照してください。 |

## <a name="see-also"></a>関連項目

- [Visual Studio 2017 でのリアルタイム依存関係の検証](https://blogs.msdn.microsoft.com/devops/2016/11/30/live-dependency-validation-in-visual-studio-2017/)
- [開発時のシステムの検証](../modeling/validate-your-system-during-development.md)
- [ビデオ:リアルタイムでアーキテクチャ依存関係を検証します。](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)
